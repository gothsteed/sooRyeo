<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">


<!-- ==== #29. 루트 엘리먼트 & 네임스페이스 설정(프로젝트 전체내에서 유일해야 한다.) ==== -->
<mapper namespace="professor">
	
	<resultMap id="professorResultMap" type="com.sooRyeo.app.domain.Professor">
        <id property="prof_id" column="prof_id"/>
        <result property="pwd" column="pwd"/>
        <result property="name" column="name"/>
        <result property="tel" column="tel"/>
        <result property="email" column="email"/>
        <result property="office_address" column="office_address"/>
        <result property="img_name" column="img_name"/>
        <association property="department" javaType="com.sooRyeo.app.domain.Department">
            <id property="departmentSeq" column="department_seq"/>
            <result property="department_name" column="department_name"/>
        </association>
    </resultMap>
	<select id="selectProfessor" resultMap="professorResultMap" parameterType="com.sooRyeo.app.dto.LoginDTO">  <!-- VO에 있는 필드명과 select 해온 컬럼명은 같아야한다!! -->
		SELECT P.PROF_ID, P.PWD, P.NAME, P.TEL, D.DEPARTMENT_NAME, P.EMAIL, P.OFFICE_ADDRESS, P.IMG_NAME
		FROM 
    	(SELECT prof_id, pwd, name, tel, department_seq, email, office_address, img_name
     	FROM tbl_professor) P
		JOIN 
    	(SELECT department_seq, department_name
     	FROM tbl_department) D
		ON P.department_seq = D.department_seq
		WHERE P.prof_id = #{id} AND P.pwd = #{password}				
	</select>
	
	
	<select id="selectInfo" resultMap="professorResultMap" parameterType="com.sooRyeo.app.domain.Professor">
		SELECT P.PROF_ID, P.PWD, P.NAME, P.TEL, D.DEPARTMENT_NAME, P.EMAIL, P.OFFICE_ADDRESS
		FROM 
    	(SELECT prof_id, pwd, name, tel, department_seq, email, office_address
     	FROM tbl_professor) P
		JOIN 
    	(SELECT department_seq, department_name
     	FROM tbl_department) D
		ON P.department_seq = D.department_seq
		WHERE P.prof_id = #{prof_id}
	</select>
	
	
	<select id="pwdDuplicateCheck" resultType="int" parameterType="HashMap">
		select count(*)
		from tbl_professor
		where prof_id = to_number(#{prof_id}) and pwd = #{pwd}
	</select>
	
	
	<select id="telDuplicateCheck" resultType="int" parameterType="HashMap">
		select count(*)
		from tbl_professor
		where prof_id = to_number(#{prof_id}) and tel = #{tel}
	</select>
	
	
	<select id="emailDuplicateCheck" resultType="int" parameterType="HashMap">
		select count(*)
		from tbl_professor
		where prof_id = to_number(#{prof_id}) and email = #{email}
	</select>
	
	
	<update id="professor_info_edit" parameterType="HashMap">
		update tbl_professor set pwd = #{pwd}, office_address = #{address}, email = #{email}, tel = #{tel}
		<choose>
			<when test='img_name != "" '>
			, img_name = #{img_name}
			</when>
		</choose>  
		where prof_id = to_number(#{prof_id})
	</update>
	
	
	<select id="select_file_name" resultType="com.sooRyeo.app.domain.Professor" parameterType="HashMap">
		select img_name
		from tbl_professor
		where prof_id = to_number(#{prof_id}) 
	</select>
	
	
	<update id="delFilename" parameterType="String">
		update tbl_professor set img_name = NULL
		where prof_id = to_number(#{prof_id})
	</update>
	
	
	<resultMap id="professorCourseMap" type="com.sooRyeo.app.domain.Professor">
        	<id property="prof_id" column="prof_id"/>
        	<result property="name" column="prof_name"/>
        <association property="course" javaType="com.sooRyeo.app.domain.Course">
            <id property="course_seq" column="course_seq"/>
            <result property="capacity" column="capacity"/>
            <result property="semester_date" column="semester_date"/>
        </association>
        <association property="curriculum" javaType="com.sooRyeo.app.domain.Curriculum">
            <id property="curriculum_seq" column="course_seq"/>
            <result property="grade" column="grade"/>
            <result property="fk_department_seq" column="fk_department_seq"/>
            <result property="name" column="name"/>
            <result property="credit" column="credit"/>
            <result property="required" column="required"/>
            <result property="exist" column="exist"/>
        </association>
    </resultMap>
	<select id="professor_course" resultMap="professorCourseMap" parameterType="String">
		SELECT P.prof_id AS prof_id,
			P.name AS prof_name, 
       		C.COURSE_SEQ AS course_seq, 
       		C.FK_CURRICULUM_SEQ AS fk_curriculum_seq, 
       		C.CAPACITY AS capacity, 
       		C.SEMESTER_DATE AS semester_date,
       		CU.fk_department_seq AS fk_department_seq, 
       		CU.grade AS grade, 
       		CU.name AS name, 
       		CU.credit AS credit, 
       		CU.required AS required, 
       		CU.exist AS exist 
		FROM tbl_professor P
		JOIN tbl_course C ON P.prof_id = C.fk_professor_id
		JOIN tbl_curriculum CU ON CU.curriculum_seq = C.fk_curriculum_seq
		where P.prof_id = to_number(#{prof_id}) 
	</select>


</mapper>